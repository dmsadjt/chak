<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chak</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="header">
                <h1>Chak's Setting</h1>
            </div>
            <div class="sidebar-body">
                <h2>Chat Model</h2>
                <select id="modelSelect" class="model-select">
                    <option value="">Loading models...</option>
                </select>

                <div class="profile-selector">
                    <h2>Profile:</h2>
                    <select id="profileSelect" name="profile" class="model-select">
                        <option value="">Loading...</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="chat-bar">
            <div class="header">
                <h1>Chak</h1>
            </div>
            
            <div class="chat-area" id="chatArea">
                <div class="message assistant">
                    <div class="message-avatar">AI</div>
                    <div class="message-content">
                        Hello! I'm your local AI assistant powered by Ollama. How can I help you today?
                    </div>
                </div>
            </div>
            
            <div class="input-area">
                <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 20px; justify-content: end">
                    <label style="display: flex; align-items: center; gap: 6px; font-size: 14px; cursor: pointer;" class="toggle">
                        <input type="checkbox" id="chatMode" checked style="cursor: pointer;">
                        <span class="slider"></span>
                        Chat Mode
                    </label>
                    <label class="toggle" style="display: flex; align-items: center; gap: 6px; font-size: 14px; cursor: pointer;">
                        <input type="checkbox" id="webSearch" style="cursor: pointer;">
                        <span class="slider"></span>
                        üîç Web Search
                    </label>
                </div>
                <div class="input-container">
                    <input 
                        type="text" 
                        id="userInput" 
                        placeholder="Type your message here..."
                        autocomplete="off"
                    >
                    <button id="sendBtn">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        const chatArea = document.getElementById('chatArea');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const modelSelect = document.getElementById('modelSelect');
        const chatMode = document.getElementById('chatMode');
        const webSearch = document.getElementById('webSearch');
        const profileSelect = document.getElementById('profileSelect');

        let currentModel = '';
        let conversationHistory = [];
        const OLLAMA_URL = 'http://localhost:11434';

        async function loadProfiles() {
            try {
                const response = await fetch('http://localhost:5000/profiles')
                const profiles = await response.json();

                const activeResponse = await fetch('http://localhost:5000/profile/active')
                const activeProfile = await activeResponse.json();

                profileSelect.innerHTML = '';

                profiles.forEach(profile => {
                    const option = document.createElement('option');
                    option.value = profile.id;
                    option.textContent = `${profile.name} - ${profile.description}`;

                    if (profile.name === activeProfile.name) {
                        option.selected = true;
                    }

                    profileSelect.appendChild(option);
                })
            } catch (error) {
                console.error('Failed to load profiles:', error);
                profileSelect.innerHTML = '<option>Error loading profiles</option>';
            }
        }

        profileSelect.addEventListener('change', async (e) => {
            const profileName = e.target.value;

            try {
                const response = await fetch('http://localhost:5000/profile/switch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json'},
                    body: JSON.stringify({ profile_name: profileName })
                });

                const result = await response.json();
                if (result.status === 'success') {
                    console.log('Switched to:', result.active_profile.name);
                    alert(`Switched to ${result.active_profile.name} profile!\n\nNote: Restart server to fully apply changes.`);
                }
            } catch (error) {
                console.error('Failed to switch profile:', error);
                alert('Failed to switch profile.');
            }

        });


        document.body.addEventListener("htmx:afterOnLoad", function(evt) {
            if (evt.detail.elt.id === "profileSelect") {
                const data = JSON.parse(evt.detail.xhr.responseText);

                evt.detail.elt.innerHTML = data.map(item =>
                    `<option value="${item.name}">${item.name}</option>`
                ).join("");
            }
        });

        function showSearchIndicator() {
            const searchDiv = document.createElement('div');
            searchDiv.id = 'searchIndicator';
            searchDiv.className = 'message assistant';
            searchDiv.innerHTML = `
                <div class="message-avatar">üîç</div>
                <div class="message-content">Searching the web...</div>
            `;
            chatArea.appendChild(searchDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function removeSearchIndicator() {
            const indicator = document.getElementById('searchIndicator');
            if (indicator) indicator.remove();
        }

        // Detect if model is instruct or base
        function isInstructModel(modelName) {
            return modelName.includes('instruct') || modelName.includes('chat');
        }

        async function loadEmbeddingModels() {
            try {
                const response = await fetch(`${OLLAMA_URL}/api/tags`);
                const data = await response.json();


                if (data.models && data.models.length > 0) {
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.name;
                        option.textContent = model.name;
                    });
                    currentModel = data.models[0].name;
                } else {
                    modelSelect.innerHTML = '<option value="">No models found</option>';
                }
            } catch (error) {
    
            }
        
        }

        // Load available models
        async function loadModels() {
            try {
                const response = await fetch(`${OLLAMA_URL}/api/tags`);
                const data = await response.json();
                
                modelSelect.innerHTML = '';
                
                if (data.models && data.models.length > 0) {
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.name;
                        option.textContent = model.name;
                        modelSelect.appendChild(option);
                    });
                    currentModel = data.models[0].name;
                } else {
                    modelSelect.innerHTML = '<option value="">No models found</option>';
                }
            } catch (error) {
                showError('Failed to load models. Make sure Ollama is running on localhost:11434');
                modelSelect.innerHTML = '<option value="">Error loading models</option>';
            }
        }

        modelSelect.addEventListener('change', (e) => {
            currentModel = e.target.value;
            // Auto-toggle chat mode based on model type
            chatMode.checked = isInstructModel(currentModel);
            // Clear history when switching models
            conversationHistory = [];
        });

        chatMode.addEventListener('change', () => {
            if (chatMode.checked) {
                userInput.placeholder = "Type your message here...";
            } else {
                userInput.placeholder = "Start typing code to complete...";
            }
        });

        webSearch.addEventListener('change', () => {
            if (webSearch.checked) {
                userInput.style.borderColor = '#10b981';
                userInput.placeholder = "Ask a question to search the web...";
            } else {
                userInput.style.borderColor = '#e5e7eb';
                userInput.placeholder = chatMode.checked ? "Type your message here..." : "Start typing code to complete...";
            }
        });

        function addMessage(content, isUser, totalTime, totalTokens) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = isUser ? 'You' : 'AI';

            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'message-content';
            
            const contentDiv = document.createElement('div');
            //contentDiv.className = 'message-content';
            contentDiv.innerHTML = marked.parse(content);


            contentWrapper.appendChild(contentDiv);

            if (isUser == false) {
                const statsDiv = document.createElement('div');
                statsDiv.className = 'message-stats';
                statsDiv.textContent = `time taken: ${totalTime}s, total tokens: ${totalTokens}`;
                contentWrapper.appendChild(statsDiv);

                // --- Feedback (Tombol Thumbs Up/Down) ---
                const feedbackDiv = document.createElement('div');
                feedbackDiv.className = 'message-feedback';
                
                // Tombol Thumbs Up (Suka)
                const upButton = document.createElement('button');
                upButton.className = 'feedback-button thumb-up';
                // Menggunakan ikon Font Awesome (ganti dengan '&#x1F44D;' jika tanpa FA)
                upButton.innerHTML = '<i class="fas fa-thumbs-up"></i>'; 
                upButton.title = 'Suka';
                // Tambahkan event listener di sini (opsional)
                upButton.addEventListener('click', () => handleFeedback('up', content));

                // Tombol Thumbs Down (Tidak Suka)
                const downButton = document.createElement('button');
                downButton.className = 'feedback-button thumb-down';
                // Menggunakan ikon Font Awesome (ganti dengan '&#x1F44E;' jika tanpa FA)
                downButton.innerHTML = '<i class="fas fa-thumbs-down"></i>';
                downButton.title = 'Tidak Suka';
                // Tambahkan event listener di sini (opsional)
                downButton.addEventListener('click', () => handleFeedback('down', content));

                feedbackDiv.appendChild(upButton);
                feedbackDiv.appendChild(downButton);
                contentWrapper.appendChild(feedbackDiv);
            }
            

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentWrapper);
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
            
            return contentDiv;
        }

        function showLoading() {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            messageDiv.id = 'loadingMessage';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = 'AI';
            
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message-content loading';
            loadingDiv.innerHTML = '<span></span><span></span><span></span>';
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(loadingDiv);
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function removeLoading() {
            const loadingMsg = document.getElementById('loadingMessage');
            if (loadingMsg) {
                loadingMsg.remove();
            }
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            chatArea.appendChild(errorDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }


        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message || !currentModel) return;

            const bSearchEnabled = webSearch.checked;

            addMessage(message, true, 0, 0);
            userInput.value = '';
            sendBtn.disabled = true;

            showLoading();

            try {
                let response;
                
                if (chatMode.checked) {
                    conversationHistory.push({
                        role: 'user',
                        content: message
                    });

                    response = await fetch(`http://localhost:5000/chat`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model: currentModel,
                            messages: conversationHistory,
                            search: bSearchEnabled
                        })
                    });
                } 

                removeLoading();

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const aiResponse = data.response;
                const totalTokens = data.tokens;
                const totalTime = data.time;
                
                if (chatMode.checked) {
                    conversationHistory.push({
                        role: 'assistant',
                        content: aiResponse
                    });
                }
                
                addMessage(aiResponse, false, totalTime, totalTokens);

            } catch (error) {
                removeLoading();
                showError(`Error: ${error.message}`);
            } finally {
                sendBtn.disabled = false;
                userInput.focus();
            }
        }

        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Load models on startup
        loadModels();
        loadEmbeddingModels();
        loadProfiles();
    </script>
</body>
</html
